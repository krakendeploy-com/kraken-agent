# .github/workflows/release-agent.yml
name: Tag & release Kraken.Agent on master merge

on:
  push:
    branches: [ master ]
    paths:
      - 'src/Kraken.Agent/**'
      - 'src/Kraken.Agent.Installer/**'
      - '.github/workflows/release-agent.yml'
  workflow_dispatch: {}

permissions:
  contents: write
  packages: read

env:
  DOTNET_VERSION: '9.0.x'
  AGENT_CSPROJ: src/Kraken.Agent/Kraken.Agent.csproj
  INSTALLER_CSPROJ: src/Kraken.Agent.Installer/Kraken.Agent.Installer.csproj

jobs:
  version:
    name: Determine next version & create local tag
    if: ${{ !startsWith(github.ref, 'refs/tags/') }}
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.ver.outputs.next }}
      version: ${{ steps.ver.outputs.next_no_v }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine next version (patch bump)
        id: ver
        shell: bash
        run: |
          latest=$(git tag -l 'v*.*.*' --sort=-v:refname | head -n1)
          if [ -z "$latest" ]; then next="v1.0.0"; else
            IFS='.' read -r major minor patch <<<"${latest#v}"
            next="v${major}.${minor}.$((patch+1))"
          fi
          echo "next=$next" >> "$GITHUB_OUTPUT"
          echo "next_no_v=${next#v}" >> "$GITHUB_OUTPUT"
          echo "Next version: $next"

      - name: Create local tag
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.ver.outputs.next }}" -m "Release ${{ steps.ver.outputs.next }}"

  build:
    name: Build for ${{ matrix.platform }}
    needs: version
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
            agent_artifact_name: Kraken.Agent-linux-x64.zip
            installer_artifact_name: Kraken.Agent.Installer-linux-x64.zip
          - os: ubuntu-latest
            platform: linux-arm64
            agent_artifact_name: Kraken.Agent-linux-arm64.zip
            installer_artifact_name: Kraken.Agent.Installer-linux-arm64.zip
          - os: windows-latest
            platform: win-x64
            agent_artifact_name: Kraken.Agent-win-x64.zip
            installer_artifact_name: Kraken.Agent.Installer-win-x64.zip

    env:
      BUILD_NUMBER: ${{ needs.version.outputs.version }} # 1.2.3 (no 'v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Restore local tag
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ needs.version.outputs.tag }}" -m "Release ${{ needs.version.outputs.tag }}" || true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # --- Auth to GitHub Packages (Unix) ---
      - name: Authenticate to GitHub Packages (NuGet) [Unix]
        if: runner.os != 'Windows'
        shell: bash
        run: |
          dotnet nuget remove source github || true
          dotnet nuget add source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" --name "github" --username "${{ github.actor }}" --password "${{ secrets.GITHUB_TOKEN }}" --store-password-in-clear-text
          dotnet nuget list source

      # --- Auth to GitHub Packages (Windows) ---
      - name: Authenticate to GitHub Packages (NuGet) [Windows]
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          dotnet nuget remove source github 2>$null
          dotnet nuget add source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" --name "github" --username "${{ github.actor }}" --password "${{ secrets.GITHUB_TOKEN }}" --store-password-in-clear-text
          dotnet nuget list source

      # -------- Publish Agent (Unix) --------
      - name: Publish Agent [Unix]
        if: runner.os != 'Windows'
        shell: bash
        run: |
          echo "Building Kraken.Agent for ${{ matrix.platform }} - Version ${BUILD_NUMBER}"
          OUT_DIR="$RUNNER_TEMP/out/${{ matrix.platform }}/Kraken.Agent"
          mkdir -p "$OUT_DIR"
          dotnet publish "${{ env.AGENT_CSPROJ }}" -c Release -r ${{ matrix.platform }} -p:Version=${BUILD_NUMBER} -o "$OUT_DIR"
          echo "${BUILD_NUMBER}" > "$OUT_DIR/version.txt"

      # -------- Publish Agent (Windows) --------
      - name: Publish Agent [Windows]
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "Building Kraken.Agent for $env:RUNNER_OS - RID ${{ matrix.platform }} - Version $env:BUILD_NUMBER"
          $outDir = "$env:RUNNER_TEMP/out/${{ matrix.platform }}/Kraken.Agent"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          dotnet publish "${{ env.AGENT_CSPROJ }}" -c Release -r ${{ matrix.platform }} -p:Version=$env:BUILD_NUMBER -o "$outDir"
          Set-Content -Path (Join-Path $outDir 'version.txt') -Value $env:BUILD_NUMBER

      # -------- Publish Installer (Unix) --------
      - name: Publish Installer [Unix]
        if: runner.os != 'Windows'
        shell: bash
        run: |
          echo "Building Kraken.Agent.Installer for ${{ matrix.platform }} - Version ${BUILD_NUMBER}"
          OUT_DIR="$RUNNER_TEMP/out/${{ matrix.platform }}/Kraken.Agent.Installer"
          mkdir -p "$OUT_DIR"
          dotnet publish "${{ env.INSTALLER_CSPROJ }}" -c Release -r ${{ matrix.platform }} -p:Version=${BUILD_NUMBER} -o "$OUT_DIR"
          echo "${BUILD_NUMBER}" > "$OUT_DIR/version.txt"

      # -------- Publish Installer (Windows) --------
      - name: Publish Installer [Windows]
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "Building Kraken.Agent.Installer for $env:RUNNER_OS - RID ${{ matrix.platform }} - Version $env:BUILD_NUMBER"
          $outDir = "$env:RUNNER_TEMP/out/${{ matrix.platform }}/Kraken.Agent.Installer"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          dotnet publish "${{ env.INSTALLER_CSPROJ }}" -c Release -r ${{ matrix.platform }} -p:Version=$env:BUILD_NUMBER -o "$outDir"
          Set-Content -Path (Join-Path $outDir 'version.txt') -Value $env:BUILD_NUMBER

      # -------- Zip (Unix) --------
      - name: Zip artifacts (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          AGENT_DIR="$RUNNER_TEMP/out/${{ matrix.platform }}/Kraken.Agent"
          INSTALLER_DIR="$RUNNER_TEMP/out/${{ matrix.platform }}/Kraken.Agent.Installer"
          mkdir -p "$RUNNER_TEMP/zips"
          (cd "$AGENT_DIR" && zip -r "$RUNNER_TEMP/zips/${{ matrix.agent_artifact_name }}" .)
          (cd "$INSTALLER_DIR" && zip -r "$RUNNER_TEMP/zips/${{ matrix.installer_artifact_name }}" .)
          ls -l "$RUNNER_TEMP/zips"

      # -------- Zip (Windows) --------
      - name: Zip artifacts (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $agentDir     = "$env:RUNNER_TEMP/out/${{ matrix.platform }}/Kraken.Agent"
          $installerDir = "$env:RUNNER_TEMP/out/${{ matrix.platform }}/Kraken.Agent.Installer"
          $zipRoot      = "$env:RUNNER_TEMP/zips"
          New-Item -ItemType Directory -Force -Path $zipRoot | Out-Null
          Compress-Archive -Path "$agentDir/*" -DestinationPath (Join-Path $zipRoot "${{ matrix.agent_artifact_name }}") -Force
          Compress-Archive -Path "$installerDir/*" -DestinationPath (Join-Path $zipRoot "${{ matrix.installer_artifact_name }}") -Force
          Get-ChildItem $zipRoot

      - name: Upload Agent artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.agent_artifact_name }}
          path: ${{ runner.temp }}/zips/${{ matrix.agent_artifact_name }}
          retention-days: 90

      - name: Upload Installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.installer_artifact_name }}
          path: ${{ runner.temp }}/zips/${{ matrix.installer_artifact_name }}
          retention-days: 90

  release:
    name: Create GitHub Release (and push tag)
    needs: [version, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Push tag to origin
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ needs.version.outputs.tag }}" -m "Release ${{ needs.version.outputs.tag }}" || true
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
          git push origin "${{ needs.version.outputs.tag }}"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Generate changelog
        id: changelog
        env:
          VERSION: ${{ needs.version.outputs.version }}
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 "v${VERSION}^" 2>/dev/null || echo "")
          {
            echo "## Kraken Agent Installer v${VERSION}"
            echo
            echo "### Downloads"
            echo "- **Linux x64**: \`Kraken.Agent.Installer-linux-x64.zip\`"
            echo "- **Linux ARM64**: \`Kraken.Agent.Installer-linux-arm64.zip\`"
            echo "- **Windows x64**: \`Kraken.Agent.Installer-win-x64.zip\`"
            echo
            echo "### Installation"
            echo "1. Download the appropriate package for your platform"
            echo "2. Extract the ZIP file"
            echo "3. Run the installer executable"
            echo
            echo "## Changes"
            echo
            if [ -z "$PREV_TAG" ]; then
              echo "Initial release"
            else
              echo "### Features"
              git log "$PREV_TAG"..v"$VERSION" --pretty=format:"- %s (%h)" --grep="^feat:" --grep="^feature:" || echo "- None"
              echo
              echo "### Bug Fixes"
              git log "$PREV_TAG"..v"$VERSION" --pretty=format:"- %s (%h)" --grep="^fix:" --grep="^bugfix:" || echo "- None"
              echo
              echo "### Other Changes"
              git log "$PREV_TAG"..v"$VERSION" --pretty=format:"- %s (%h)" --invert-grep --grep="^feat:" --grep="^feature:" --grep="^fix:" --grep="^bugfix:" || echo "- None"
              echo
              echo "---"
              echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...v${VERSION}"
            fi
          } > changelog.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.tag }}
          name: Release ${{ needs.version.outputs.tag }}
          body_path: changelog.md
          files: artifacts/**/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# .github/workflows/release-agent-like-models.yml
name: Tag & release Kraken.Agent on master merge

on:
  push:
    branches: [ master ]
    # Limit to agent-related changes if you like
    paths:
      - 'src/Kraken.Agent/**'
      - 'src/Kraken.Installer/**'

permissions:
  contents: write
  packages: write

env:
  DOTNET_VERSION: '9.0.x'

jobs:
  version:
    name: Determine next version & create local tag
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.ver.outputs.next }}
      version: ${{ steps.ver.outputs.next_no_v }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine next version (patch bump)
        id: ver
        shell: bash
        run: |
          latest=$(git tag -l 'v*.*.*' --sort=-v:refname | head -n1)
          if [ -z "$latest" ]; then next="v1.0.0"; else
            IFS='.' read -r major minor patch <<<"${latest#v}"
            next="v${major}.${minor}.$((patch+1))"
          fi
          echo "next=$next" >> "$GITHUB_OUTPUT"
          echo "next_no_v=${next#v}" >> "$GITHUB_OUTPUT"
          echo "Next version: $next"

      - name: Create local tag
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.ver.outputs.next }}" -m "Release ${{ steps.ver.outputs.next }}"

  build:
    name: Build for ${{ matrix.platform }}
    needs: version
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
            agent_artifact_name: Kraken.Agent-linux-x64.zip
            installer_artifact_name: Kraken.Agent.Installer-linux-x64.zip
          - os: ubuntu-latest
            platform: linux-arm64
            agent_artifact_name: Kraken.Agent-linux-arm64.zip
            installer_artifact_name: Kraken.Agent.Installer-linux-arm64.zip
          - os: windows-latest
            platform: win-x64
            agent_artifact_name: Kraken.Agent-win-x64.zip
            installer_artifact_name: Kraken.Agent.Installer-win-x64.zip

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # (Re)create the local tag so this job also sees it
      - name: Restore local tag
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ needs.version.outputs.tag }}" -m "Release ${{ needs.version.outputs.tag }}" || true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          source-url: https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Agent
        shell: bash
        working-directory: ./scripts
        env:
          BUILD_NUMBER: ${{ needs.version.outputs.version }}   # 1.2.3 (no 'v')
        run: |
          chmod +x "build-agent-${{ matrix.platform }}.sh"
          ./build-agent-${{ matrix.platform }}.sh

      - name: Build Installer
        shell: bash
        working-directory: ./scripts
        env:
          BUILD_NUMBER: ${{ needs.version.outputs.version }}
        run: |
          chmod +x "build-agent-installer-${{ matrix.platform }}.sh"
          ./build-agent-installer-${{ matrix.platform }}.sh

      - name: Upload Agent artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.agent_artifact_name }}
          path: scripts/build/${{ matrix.agent_artifact_name }}
          retention-days: 90

      - name: Upload Installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.installer_artifact_name }}
          path: scripts/build/${{ matrix.installer_artifact_name }}
          retention-days: 90

  release:
    name: Create GitHub Release (and push tag)
    needs: [version, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Recreate tag in this job and push it only now (after build succeeded)
      - name: Push tag to origin
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # re-tag locally (no-op if identical)
          git tag -a "${{ needs.version.outputs.tag }}" -m "Release ${{ needs.version.outputs.tag }}" || true
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
          git push origin "${{ needs.version.outputs.tag }}"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Generate changelog
        id: changelog
        env:
          VERSION: ${{ needs.version.outputs.version }}
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 "v${VERSION}^" 2>/dev/null || echo "")
          {
            echo "## Kraken Agent Installer v${VERSION}"
            echo
            echo "### Downloads"
            echo "- **Linux x64**: \`Kraken.Agent.Installer-linux-x64.zip\`"
            echo "- **Linux ARM64**: \`Kraken.Agent.Installer-linux-arm64.zip\`"
            echo "- **Windows x64**: \`Kraken.Agent.Installer-win-x64.zip\`"
            echo
            echo "### Installation"
            echo "1. Download the appropriate package for your platform"
            echo "2. Extract the ZIP file"
            echo "3. Run the installer executable"
            echo
            echo "## Changes"
            echo
            if [ -z "$PREV_TAG" ]; then
              echo "Initial release"
            else
              echo "### Features"
              git log "$PREV_TAG"..v"$VERSION" --pretty=format:"- %s (%h)" --grep="^feat:" --grep="^feature:" || echo "- None"
              echo
              echo "### Bug Fixes"
              git log "$PREV_TAG"..v"$VERSION" --pretty=format:"- %s (%h)" --grep="^fix:" --grep="^bugfix:" || echo "- None"
              echo
              echo "### Other Changes"
              git log "$PREV_TAG"..v"$VERSION" --pretty=format:"- %s (%h)" --invert-grep --grep="^feat:" --grep="^feature:" --grep="^fix:" --grep="^bugfix:" || echo "- None"
              echo
              echo "---"
              echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...v${VERSION}"
            fi
          } > changelog.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.tag }}       # vX.Y.Z
          name: Release ${{ needs.version.outputs.tag }}
          body_path: changelog.md
          files: artifacts/**/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

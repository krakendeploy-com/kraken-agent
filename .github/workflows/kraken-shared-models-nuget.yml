name: Publish NuGet Package

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'  # Trigger on version tags
  pull_request:
    branches:
      - main

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for GitVersion

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.x'

      - name: Setup GitVersion
        uses: gittools/actions/gitversion/setup@v0.10.2
        with:
          versionSpec: '5.x'

      - name: Run GitVersion
        id: gitversion
        uses: gittools/actions/gitversion/execute@v0.10.2

      - name: Restore dependencies
        run: dotnet restore src/Kraken.Shared.Models/Kraken.Shared.Models.csproj

      - name: Build
        run: dotnet build src/Kraken.Shared.Models/Kraken.Shared.Models.csproj -c Release --no-restore

      - name: Pack NuGet package
        run: |
          dotnet pack src/Kraken.Shared.Models/Kraken.Shared.Models.csproj \
            -c Release --no-build \
            /p:PackageVersion=${{ steps.gitversion.outputs.nuGetVersionV2 }}

      - name: Configure GitHub NuGet source
        run: |
          if dotnet nuget list source | grep -q "github"; then
            dotnet nuget update source github \
              --username krakendeploy-com \
              --password "${{ secrets.GITHUB_TOKEN }}" \
              --store-password-in-clear-text
          else
            dotnet nuget add source "https://nuget.pkg.github.com/krakendeploy-com/index.json" \
              --name github \
              --username krakendeploy-com \
              --password "${{ secrets.GITHUB_TOKEN }}" \
              --store-password-in-clear-text
          fi

      - name: Push to GitHub Packages
        run: |
          dotnet nuget push src/Kraken.Shared.Models/bin/Release/*.nupkg \
            --source github \
            --api-key ${{ secrets.GITHUB_TOKEN }}
